@startuml Ammo Collector Workflow
!theme plain

title Ammo Collector Workflow

actor User
participant Microservice
User -> Collector: Send task  

participant AmmoClient as "ammoclient\n(pkg)"
queue Kafka
participant "Ammo Collector" as Collector
database PostgreSQL
database S3

Collector -> PostgreSQL: Create collection

Microservice -> AmmoClient: SendGRPCRequest/SendHTTPRequest
AmmoClient -> Kafka: Publish requests

loop Background Processing
  Collector -> Kafka: Consume requests
  Collector -> Collector: Check against collection criteria
  
  alt Matches criteria
    Collector -> PostgreSQL: Store request
    Collector -> PostgreSQL: Link to collection
  end
end

Collector -> Collector: Monitor collection status

alt Task completion
  Collector -> PostgreSQL: Gather requests
  Collector -> S3: Zip & store archive  
end

|||

group Maintenance
  Collector -> PostgreSQL: Clean old requests
  Collector -> S3: Clean old archives
end

User -> Collector: Check collection state
User -> Collector: Retrieve zip archive
User --> S3: Retrieve zip archive (optional)

@enduml
